# gotunnel 架构设计与关键注意事项

## 一、整体架构思想
- 服务端与多个客户端维持长连接，实现统一控制和数据转发。
- 支持海量客户端并发注册，适配云原生/K8s 场景。
- 控制通道负责指令管理、心跳、状态同步；数据通道负责大数据流量转发。
- 系统分层清晰，便于后续功能扩展与协议切换。

## 二、注意事项

### 1. 控制通道粘包/分包问题与消息边界方案（方案B）
- TCP 是字节流协议，直接传输 JSON 或二进制消息会遇到粘包/分包问题，必须解决“消息边界”才能正确传输与解析多条消息。
- 采用“包头 + 长度”协议，每条控制消息前先写定长的长度字段（如 int32，4字节），紧跟实际消息数据（如 json 字节流）。接收端先读长度，再完整读消息，保证拆包准确。
- 兼容性强，便于后期升级为 Protobuf 或自定义二进制协议。

---

## 三、开发阶段与任务分解

### 阶段一：内网穿透核心实现（MVP 阶段）
- 仅专注于 gotunnel 后端核心：Server/Client 端到端通信、控制协议（JSON+包头+长度）、数据通道转发、心跳/断连/重连管理
- 日志、基础参数配置、单元测试
default
- 所有日常运维/节点状态，仅通过命令行、日志或简单脚本辅助验证
- Web 管理界面、API、可视化等内容本阶段不开发、只作为后续功能预埋接口

### 阶段二：Web 管理 UI 与高级历史审计
- 完成穿透主链路闭环并稳定后，进入 Web 管理后台研发
- 启用 RESTful API、前端 React 管理台，实现节点在线/历史行为、状态统计等功能
- 前端管理页面必须有登录认证，防止未授权访问
- 考虑会话历史记录、数据可视化、快捷运维与 push 支持等

### 阶段三：云原生友好及生态扩展
- 云原生环境下的批量部署、自动发现
- 多实例高可用、监控/流量告警等
- 插件、ACL、协议扩展等

---

## 四、Web 管理 UI 设计（React 版）

### 1. 登录认证功能
- **必须实现前端 Web 管理台登录功能**，防止未授权访问后台页面。
- 推荐账号/密码认证，用户信息支持后端配置或数据库持久化。
- 前后端所有 API 调用需带认证信息（如 JWT/Session/Cookie）。
- 登录失败自动拦截所有前后端资源访问。

### 2. 技术选型
- 前端 React + Ant Design（或同类表格组件）
- 后端 Go Gin/Chi 提供 RESTful API，支持后续 websocket/鉴权升级

### 3. 前端目录及页面设计
- /login 登录页
- /clients 在线客户端监控列表
- /sessions 历史记录展示页
- 公共 UI 组件与 API 封装

### 4. 主要功能清单和接口
- 实时显示在线客户端、数据通道、快捷操作
- 查询与下载历史日志
- 具备一键断开、刷新等基本管理能力

### 5. 开发分阶段建议
- 阶段一：登录认证页、mock 数据驱动列表开发
- 阶段二：联调 API、加历史日志、逐步深度完善
- 阶段三：界面优化、权限与上线安全

> 登录安全是生产场景的首要要求，建议项目初期就落地，防止任何未授权/绕过访问风险。

## 端口注册协议与流量中继实现

### 1. 端口注册协议
- 客户端启动后应通过控制通道发送 RegisterRequest 消息进行端口映射注册。例如：
  {
    "type": "register",
    "local_port": 22,
    "remote_port": 10022,
    "protocol": "tcp",
    "token": "changeme",
    "name": "gotunnel-demo"
  }
- 服务端收到后，回复 RegisterResponse（status: ok/fail），并动态监听 remote_port，实现映射表更新。

### 2. 双向流量中继 relay 设计
- 数据通道建立后，通过 core/relay.go 中 RelayConn(a, b) 进行全透明 TCP 数据转发。
- RelayConn 保证双方字节流全双工直通，支持所有高层协议（如 ssh、http），核心代码如下：
  ```go
  func RelayConn(a, b net.Conn) {
      go func() { io.Copy(b, a); b.Close() }()
      io.Copy(a, b); a.Close()
  }
  ```
- 这样能确保公网访问 server:remote_port 时，就像直连 client:local_port，满足 SSH 等协议的长连接、数据量大场景。

更多具体协议/中继流程见 protocol.go 和 core/relay.go 详细注释。
